package leetcode.math;
//åœ¨è€ƒåœºé‡Œï¼Œä¸€æ’æœ‰ N ä¸ªåº§ä½ï¼Œåˆ†åˆ«ç¼–å·ä¸º 0, 1, 2, ..., N-1 ã€‚
//
// å½“å­¦ç”Ÿè¿›å…¥è€ƒåœºåï¼Œä»–å¿…é¡»ååœ¨èƒ½å¤Ÿä½¿ä»–ä¸ç¦»ä»–æœ€è¿‘çš„äººä¹‹é—´çš„è·ç¦»è¾¾åˆ°æœ€å¤§åŒ–çš„åº§ä½ä¸Šã€‚å¦‚æœæœ‰å¤šä¸ªè¿™æ ·çš„åº§ä½ï¼Œä»–ä¼šååœ¨ç¼–å·æœ€å°çš„åº§ä½ä¸Šã€‚(å¦å¤–ï¼Œå¦‚æœè€ƒåœºé‡Œæ²¡æœ‰äººï¼Œ
//é‚£ä¹ˆå­¦ç”Ÿå°±ååœ¨ 0 å·åº§ä½ä¸Šã€‚)
//
// è¿”å› ExamRoom(int N) ç±»ï¼Œå®ƒæœ‰ä¸¤ä¸ªå…¬å¼€çš„å‡½æ•°ï¼šå…¶ä¸­ï¼Œå‡½æ•° ExamRoom.seat() ä¼šè¿”å›ä¸€ä¸ª int ï¼ˆæ•´å‹æ•°æ®ï¼‰ï¼Œä»£è¡¨å­¦ç”Ÿåçš„ä½
//ç½®ï¼›å‡½æ•° ExamRoom.leave(int p) ä»£è¡¨ååœ¨åº§ä½ p ä¸Šçš„å­¦ç”Ÿç°åœ¨ç¦»å¼€äº†è€ƒåœºã€‚æ¯æ¬¡è°ƒç”¨ ExamRoom.leave(p) æ—¶éƒ½ä¿è¯æœ‰å­¦ç”Ÿååœ¨
//åº§ä½ p ä¸Šã€‚
//
//
//
// ç¤ºä¾‹ï¼š
//
// è¾“å…¥ï¼š["ExamRoom","seat","seat","seat","seat","leave","seat"], [[10],[],[],[],[]
//,[4],[]]
//è¾“å‡ºï¼š[null,0,9,4,2,null,5]
//è§£é‡Šï¼š
//ExamRoom(10) -> null
//seat() -> 0ï¼Œæ²¡æœ‰äººåœ¨è€ƒåœºé‡Œï¼Œé‚£ä¹ˆå­¦ç”Ÿååœ¨ 0 å·åº§ä½ä¸Šã€‚
//seat() -> 9ï¼Œå­¦ç”Ÿæœ€åååœ¨ 9 å·åº§ä½ä¸Šã€‚
//seat() -> 4ï¼Œå­¦ç”Ÿæœ€åååœ¨ 4 å·åº§ä½ä¸Šã€‚
//seat() -> 2ï¼Œå­¦ç”Ÿæœ€åååœ¨ 2 å·åº§ä½ä¸Šã€‚
//leave(4) -> null
//seat() -> 5ï¼Œå­¦ç”Ÿæœ€åååœ¨ 5 å·åº§ä½ä¸Šã€‚
//
//
//
//
// æç¤ºï¼š
//
//
// 1 <= N <= 10^9
// åœ¨æ‰€æœ‰çš„æµ‹è¯•æ ·ä¾‹ä¸­ ExamRoom.seat() å’Œ ExamRoom.leave() æœ€å¤šè¢«è°ƒç”¨ 10^4 æ¬¡ã€‚
// ä¿è¯åœ¨è°ƒç”¨ ExamRoom.leave(p) æ—¶æœ‰å­¦ç”Ÿæ­£ååœ¨åº§ä½ p ä¸Šã€‚
//
//
// Related Topics è®¾è®¡ æœ‰åºé›†åˆ ğŸ‘ 131 ğŸ‘ 0

import java.util.HashMap;
import java.util.Map;
import java.util.TreeSet;

/**
 * @author mayanwei
 * @date 2022-08-10.
 */
public class _855_è€ƒåœºå°±åº§{
    // å•å‡¡é‡åˆ°åœ¨åŠ¨æ€è¿‡ç¨‹ä¸­å–æœ€å€¼çš„è¦æ±‚ï¼Œè‚¯å®šè¦ä½¿ç”¨æœ‰åºæ•°æ®ç»“æ„ï¼Œå¸¸ç”¨åˆ°çš„æ•°æ®ç»“æ„å°±æ˜¯äºŒå‰å †å’Œå¹³è¡¡äºŒå‰æœç´¢æ ‘
// äºŒå‰å †å®ç°çš„ä¼˜å…ˆçº§é˜Ÿåˆ—å–æœ€å€¼çš„æ—¶é—´å¤æ‚åº¦ä¸º O(logn)ä½†åªèƒ½åˆ é™¤æœ€å¤§å€¼ï¼Œå¹³è¡¡äºŒå‰æ ‘ä¹Ÿå¯ä»¥å–æœ€å€¼ï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹ã€åˆ é™¤ä»»æ„å€¼ï¼Œè€Œä¸”æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ O(logN)
// ç»¼ä¸Šï¼ŒäºŒå‰å †ä¸èƒ½æ»¡è¶³leave æ“ä½œï¼Œåº”è¯¥ä½¿ç”¨å¹³å’ŒäºŒå‰æ ‘ï¼Œè¿™é‡Œä¼šç”¨åˆ° Java çš„ä¸€ç§æ•°æ®ç»“æ„ TreeSetï¼Œè¿™æ˜¯ä¸€ç§æœ‰åºæ•°æ®ç»“æ„ï¼Œåº•å±‚æ—¶ç”±çº¢é»‘æ ‘ç»´æŠ¤çš„æœ‰åºæ€§
// ï¼Œä¸€è¯´åˆ°é›†åˆï¼ˆSetï¼‰æˆ–è€…æ˜ å°„ï¼ˆMapï¼‰ï¼Œæœ‰çš„è¯»è€…å¯èƒ½å°±æƒ³å½“ç„¶çš„è®¤ä¸ºæ˜¯å“ˆå¸Œé›†åˆï¼ˆHashSetï¼‰æˆ–è€…å“ˆå¸Œè¡¨ï¼ˆHashMapï¼‰ï¼Œè¿™æ ·ç†è§£æ˜¯æœ‰ç‚¹é—®é¢˜çš„ã€‚
// å› ä¸ºå“ˆå¸Œé›†åˆ/æ˜ å°„åº•å±‚æ˜¯ç”±å“ˆå¸Œå‡½æ•°å’Œæ•°ç»„å®ç°çš„ï¼Œç‰¹æ€§æ˜¯éå†æ— å›ºå®šé¡ºåºï¼Œä½†æ˜¯æ“ä½œæ•ˆç‡é«˜ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚
// è€Œé›†åˆ/æ˜ å°„è¿˜å¯ä»¥ä¾èµ–å…¶ä»–åº•å±‚æ•°æ®ç»“æ„ï¼Œå¸¸è§çš„å°±æ˜¯çº¢é»‘æ ‘ï¼ˆä¸€ç§å¹³è¡¡äºŒå‰æœç´¢æ ‘ï¼‰ï¼Œç‰¹æ€§æ˜¯è‡ªåŠ¨ç»´æŠ¤å…¶ä¸­å…ƒç´ çš„é¡ºåºï¼Œæ“ä½œæ•ˆç‡æ˜¯ O(logN)ã€‚è¿™ç§ä¸€èˆ¬ç§°ä¸ºã€Œæœ‰åºé›†åˆ/æ˜ å°„ã€


    /**é¦–å…ˆéœ€è¦æŠŠååœ¨æ•™å®¤çš„å­¦ç”ŸæŠ½è±¡æˆçº¿æ®µï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•çš„ç”¨ä¸€ä¸ªå¤§å°ä¸º 2 çš„æ•°ç»„è¡¨ç¤ºã€‚å¦å¤–ï¼Œæ€è·¯éœ€è¦æˆ‘ä»¬æ‰¾åˆ°ã€Œæœ€é•¿ã€çš„çº¿æ®µï¼Œè¿˜éœ€è¦å»é™¤çº¿æ®µï¼Œå¢åŠ çº¿æ®µã€‚*/
    class ExamRoom {
        // å°†ç«¯ç‚¹ p æ˜ å°„åˆ°ä»¥ p ä¸ºå·¦ç«¯ç‚¹çš„çº¿æ®µ
        private Map<Integer, int[]> startMap;
        // å°†ç«¯ç‚¹ p æ˜ å°„åˆ°ä»¥ p ä¸ºå³ç«¯ç‚¹çš„çº¿æ®µ
        private Map<Integer, int[]> endMap;
        // æ ¹æ®çº¿æ®µå¤§å°ä»å°åˆ°å¤§å­˜æ”¾æ‰€æœ‰çº¿æ®µ
        private TreeSet<int[]> pq;
        private int n;
        public ExamRoom(int n) {
            this.n = n;
            this.startMap = new HashMap<>();
            this.endMap = new HashMap<>();
            pq = new TreeSet<>((a, b) -> {
                // ç®—å‡ºä¸¤ä¸ªçº¿æ®µé•¿åº¦
                int distA = distance(a);
                int distB = distance(b);
                // å¦‚æœé•¿åº¦ç›¸åŒï¼Œå°±æ¯”è¾ƒç´¢å¼•
                if (distA == distB) {
                    return b[0]-a[0];
                }
                // é•¿åº¦æ›´é•¿çš„æ”¾åœ¨åé¢
                return distA - distB;
            });
            //åœ¨æœ‰åºé›†åˆä¸­å…ˆæ”¾ä¸€ä¸ªè™šæ‹Ÿçº¿æ®µ
            addInterval(new int[]{-1, n});
        }

        /**å»é™¤ä¸€ä¸ªçº¿æ®µ */
        private void removeInterval(int [] intv) {
            pq.remove(intv);
            startMap.remove(intv[0]);
            endMap.remove(intv[1]);
        }

        /**å¢åŠ ä¸€ä¸ªçº¿æ®µ */
        private  void addInterval(int [] intv) {
            pq.add(intv);
            startMap.put(intv[0], intv);
            endMap.put(intv[1], intv);
        }

        /**è®¡ç®—ä¸€ä¸ªçº¿æ®µé•¿åº¦ ä¸èƒ½ç®€å•åœ°è®©å®ƒè®¡ç®—ä¸€ä¸ªçº¿æ®µä¸¤ä¸ªç«¯ç‚¹é—´çš„é•¿åº¦ï¼Œè€Œæ˜¯è®©å®ƒè®¡ç®—è¯¥çº¿æ®µä¸­ç‚¹å’Œç«¯ç‚¹ä¹‹é—´çš„é•¿åº¦ã€‚*/
        private int distance(int [] intv) {
            int x = intv[0];
            int y = intv[1];
            if (x == -1) {
                return y;
            }
            else if (y == n) {
                return n-1-x;
            }
            // ä¸­ç‚¹å’Œç«¯ç‚¹ä¹‹é—´çš„é•¿åº¦
            return (y - x) / 2;
        }

        public int seat() {
            // ä»æœ‰åºé›†æ‹¿å‡ºæœ€é•¿çš„çº¿æ®µ
            int [] longest = pq.last();
            int x = longest[0];
            int y = longest[1];
            int seat;
            if (x == -1) {
                seat = 0;
            }
            else if(y == n) {
                seat = n-1;
            }
            else {
                seat = (y-x)/2 + x;
            }

            // å°†æœ€é•¿çš„çº¿æ®µåˆ†æˆä¸¤æ®µ
            int [] left = new int[] {x, seat};
            int [] right = new int[] {seat, y};
            removeInterval(longest);
            addInterval(left);
            addInterval(right);
            return seat;
        }

        public void leave(int p) {
            // å°† pp å·¦å³çš„çº¿æ®µæ‰¾å‡ºæ¥
            int [] right = startMap.get(p);
            int [] left = endMap.get(p);
            // åˆå¹¶ä¸¤ä¸ªçº¿æ®µæˆä¸ºä¸€ä¸ªçº¿æ®µ
            int [] merge = new int[]{left[0], right[1]};

            removeInterval(left);
            removeInterval(right);
            addInterval(merge);
        }
    }

/**
 * Your ExamRoom object will be instantiated and called as such:
 * ExamRoom obj = new ExamRoom(n);
 * int param_1 = obj.seat();
 * obj.leave(p);
 */
}
